---
title: "Data Joins in R (full, right, left, inner, and fuzzy)"
subtitle: "BioMarin Meetup: relational data in R"
author: 
  - "Martin Frigaard"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
---

```{r setup, include=FALSE}
library(tidyverse)
library(reprex)
library(xaringan)
library(pagedown)
library(xaringanthemer)
# folders
folders <- c("code", "data", "img", "docs", "pdfs")
purrr::map(.x = folders, .f = fs::dir_create)

knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center", 
                      dpi = 320, fig.height = 4, fig.path = "img/")

```

```{r xaringan-themer, include=FALSE, warning=FALSE}
xaringanthemer::style_duo_accent(primary_color = "#035AA6", secondary_color = "#03A696")
# xaringan::inf_mr() # for instant knitting and reviewing
```

class: inverse, center, bottom
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 50% 10%
background-size: 35%

# dplyr = a tidyverse package for data manipulation



---
class: left, top
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 15%

## Primary `dplyr` verbs:

--

### `select()` 

> ***..works on columns***

--

### `filter()` 
> ***..works on rows***

--

### `mutate()` 
> ***...creates/alters existing columns***

---
class: left, top
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 15%

## Primary `dplyr` verbs (cont):

--

### `arrange()`  
> ***...sort/order rows by columns***

--

### `group_by()`
> ***...groups data to calculate summary statistics***

--

### `summarize()`   
> ***...collapses data to calculate summary statistics***

---
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 12%
class: left, top

## dplyr joining functions

### ***`dplyr` also has functions for combining tibbles/data.frames***

### `left_join()`

--

### `right_join()`

--

### `inner_join()`

--

### `full_join()`

--

*Recall that tibbles and data.frame's are nearly identical 


---
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 12%
class: left, top

# dplyr joining functions

### Toy data `X` and `Y`

.pull-left[

```{r X}
# create X table
X <- tibble::tribble(
    ~A, ~B, ~C, 
    "a", "t", 1L,
    "b", "u", 2L,
    "c", "v", 3L)
```

```{r paged_table-X, echo=FALSE}
rmarkdown::paged_table(X)
```

]

--

.pull-right[


```{r Y}
# create Y table
Y <- tibble::tribble(
    ~A, ~B, ~D, 
    "a", "t", 3L,
    "b", "u", 2L,
    "d", "W", 1L)
```

```{r paged_table-Y, echo=FALSE}
rmarkdown::paged_table(Y)
```

]

---
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 12%
class: left, top

# `dplyr` left joins

### `left_join(x = , y = )`

#### ...joins on matches *from* right-hand table (`Y`) *to* left-hand table (`X`)

--

.pull-left[

```{r left-join, eval=FALSE}
left_join(x = X, y = Y)
```

Keep all data from `X`, and only matching data from `Y`

]

--

.pull-right[

This creates:

```{r LeftJoinXY, echo=FALSE}
LeftJoinXY <- left_join(x = X, y = Y)
rmarkdown::paged_table(LeftJoinXY)
```

]

---
background-image: url(img/left-join-01.png)
background-position: 50% 80%
background-size: 45%
class: left, top

# `dplyr` left joins (1)

### Left joins use all the data from `X` (the left-hand table)

---
background-image: url(img/left-join-02.png)
background-position: 50% 70%
background-size: 85%
class: left, top

# `dplyr` left joins (2)

### Left joins include matched data in the right-hand table `Y`, and it carries over any new corresponding columns  

---
background-image: url(img/left-join-03.png)
background-position: 50% 75%
background-size: 90%
class: left, top

# `dplyr` left join (3)

### The final data includes the new column(s) from `Y` (the right-hand table), and missing values for the unmatched rows.


---
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 12%
class: left, top

# `dplyr` right joins

### `right_join(x = , y = )` 

#### ...join on matches *from* right-hand table (`Y`) *to* left-hand table (`X`)

--

.pull-left[

```{r right-join, eval=FALSE}
right_join(x = X, y = Y)
```

Keep all data from `Y`, and only matching data from `X`

]

--

.pull-right[

This creates:

```{r RIghtJoinXY, echo=FALSE}
RIghtJoinXY <- right_join(x = X, y = Y)
rmarkdown::paged_table(RIghtJoinXY)
```

]

---
background-image: url(img/right-join-01.png)
background-position: 50% 75%
background-size: 60%
class: left, top

# `dplyr` right joins (1)

### Right joins use all the data from `Y` (the right-hand table)


---
background-image: url(img/right-join-02.png)
background-position: 50% 75%
background-size: 85%
class: left, top

# `dplyr` right joins (2)

### Right joins include the matched data in the left-hand table `X`, and they carry over any new corresponding columns  


---
background-image: url(img/right-join-03.png)
background-position: 50% 75%
background-size: 90%
class: left, top

# `dplyr` right joins (3)

### The final data includes the new column(s) from `X` (the left-hand table), and missing values for the unmatched rows.


---
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 12%
class: left, top

# `dplyr` inner joins

### `inner_join(x = , y = )` 

#### ...keep only matches in *both* `x` *and* `y`

--

.pull-left[

```{r inner-join, eval=FALSE}
inner_join(x = X, y = Y)
```

Keep only the matching data from `X` and `Y`

]

--

.pull-right[

This creates:

```{r InnerJoinXY, echo=FALSE}
InnerJoinXY <- inner_join(x = X, y = Y)
rmarkdown::paged_table(InnerJoinXY)
```

]

---
background-image: url(img/inner-join-01.png)
background-position: 50% 75%
background-size: 50%
class: left, top

# `dplyr` inner joins (1)

### Inner joins use only the matched data from both the `X` and `Y` tables

---
background-image: url(img/inner-join-02.png)
background-position: 50% 60%
background-size: 70%
class: left, top

# `dplyr` inner joins (2)

### Columns `A` and `B` are matched in both `X` and `Y` tables


---
background-image: url(img/inner-join-03.png)
background-position: 50% 60%
background-size: 85%
class: left, top

# `dplyr` inner joins (3)

### Column `C` from table `X` gets joined on matching columns `A` and `B`

---
background-image: url(img/inner-join-04.png)
background-position: 50% 60%
background-size: 90%
class: left, top

# `dplyr` inner joins (4)

### Column `D` from table `Y` gets joined on matching columns `A` and `B`


---
background-image: url(http://hexb.in/hexagons/dplyr.png)
background-position: 90% 10%
background-size: 12%
class: left, top

# `dplyr` full joins

## `full_join(x = X, y = Y)`

## ...keep *all* data in both `x` and `y`

--

.pull-left[

```{r full-join, eval=FALSE}
full_join(x = X, y = Y)
```

Keep all data from `Y` and `X`

]

--

.pull-right[

This creates:

```{r FullJoinXY, echo=FALSE}
FullJoinXY <- full_join(x = X, y = Y)
rmarkdown::paged_table(FullJoinXY)
```

]

---
background-image: url(img/full-join-01.png)
background-position: 50% 60%
background-size: 50%
class: left, top

# `dplyr` full joins (1)

### Full joins include all data from both tables `X` and `Y`

---
background-image: url(img/full-join-02.png)
background-position: 50% 60%
background-size: 70%
class: left, top

# `dplyr` full joins (2)

### Full joins start with all data in table `X` 

---
background-image: url(img/full-join-03.png)
background-position: 50% 70%
background-size: 95%
class: left, top

# `dplyr` full joins (3)

### Full joins start with all data in table `X` and include the columns and rows from table `Y`

---
class: inverse, center, middle

# Fuzzy joins

## *Fuzzy joins are joins where the keys (or ids) between the tables are inexact (i.e. 'fuzzy')*

---
class: left, top

# Installing the `fuzzyjoin` package

 You can install the `fuzzyjoin` package from CRAN or Github below:

```{r install.packages-fuzzyjoin, eval=FALSE}
install.packages("fuzzyjoin")
# or 
devtools::install_github("dgrtwo/fuzzyjoin")
```

 `fuzzyjoins` also requires the `IRanges` package from Bioconductor

```{r BiocManager-IRanges, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("IRanges")
```

---
class: left, top

## How do fuzzy joins work? 

### We often need to join data on something other than unique ids or keys


